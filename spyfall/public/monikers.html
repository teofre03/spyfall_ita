<html>
<head>
    <meta charset="utf-8">
    <title>Monikers</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="google" content="notranslate">
    <link href="http://code.jquery.com/ui/1.9.0/themes/cupertino/jquery-ui.css" rel="stylesheet">
    <script src="http://code.jquery.com/jquery-1.8.2.js"></script>
    <script src="http://code.jquery.com/ui/1.9.0/jquery-ui.js"></script>
    <script src="jquery.csv.js"></script>
    <style>
    body {
      overscroll-behavior: contain;
      font-family: "Gotham Rounded A", sans-serif;
    }
    .card{
        border: 1px solid black;
        border-radius: 10px;
        height: 410px;
        width: 260px;
        position: relative;
        display: block;
        margin: auto;
        box-shadow: 2px 2px 5px 0px rgba(0,0,0,0.75);
        pointer-events: none;
        padding: 20px;
    }
    .title{
        margin-top: 30px;
        text-align: center;
        white-space: normal;
        font-size: 18px;
        margin-top: 26px;
        margin-bottom: 23px;
        font-weight: normal;
        line-height: 23px;
        height: 23px;
    }
    .description{
        margin-top: 30px;
        height: 266px;
        text-align: center;
        white-space: normal;
        font-size: 12px;
        flex-wrap: wrap;
        margin-left: 35px;
        margin-right: 35px;
    }
    .line{
        width: 100px;
        border-bottom: 2px dotted gray;
        margin-left: 81px;
    }
    .points-box{
        border: none;
        margin: auto;
        margin-top: 28px;
        background-color: red;
        border-top-left-radius: 25px;
        border-top-right-radius: 25px;
        text-align: center;
        color: white;
        vertical-align: middle;
        background-color: #62A591;
        width: 60px;
        height: 50px;
        border-top-left-radius: 50%;
        border-top-right-radius: 50%;
        font-size: 20px;
        padding-top: 5px;
    }
    .points{
        margin-top: 10px;
        font-size: 20px;
        color: white;
    }
    .points-label{
        text-transform: uppercase;
        font-size: 8px;
    }
    .button{
        border: 1px solid black;
        border-radius: 33px;
        height: 60px;
        width: 300px;
        position: relative;
        display: block;
        margin: auto;
        margin-top: 10px;
        overflow: hidden;
    }
    .doubleButton{
        border: 1px solid black;
        border-radius: 33px;
        height: 60px;
        width: 150;
        position: relative;
        display: inline-block;
        margin: auto;
        padding-left: 5px;
        padding-right: 5px;
        margin-top: 10px;
        overflow: hidden;
    }
    #start{
        text-align: center;
        display: block;
        margin-top: 16px;
        font-weight: bold;
        font-size: 22px;
        cursor: pointer;
    }
    #skip{
        text-align: center;
        display: block;
        margin-top: 16px;
        font-weight: bold;
        font-size: 22px;
    }
    #correct{
        text-align: center;
        display: block;
        margin-top: 16px;
        font-weight: bold;
        font-size: 22px;
    }
    #skipButton{
        display: none;
        background-color: #ff9b04;
        cursor: pointer;
    }
    #correctButton{
        display: none;
        background-color: #00d81b;
        cursor: pointer;
    }
    progress[value] {
      /* Reset the default appearance */
      -webkit-appearance: none;
       appearance: none;
      width: 100%;
      height: 100%;
      border: none;
    }
    progress[value]::-webkit-progress-value {
        background-image:
           -webkit-linear-gradient(left, #30e036, #30e036);
           -webkit-animation: animate-stripes 5s linear infinite;
        animation: animate-stripes 5s linear infinite;
        border-radius: 2px;
        background-size: 35px 20px, 100% 100%, 100% 100%;
    }
    @-webkit-keyframes animate-stripes {
       100% { background-position: -100px 0px; }
    }

    @keyframes animate-stripes {
       100% { background-position: -100px 0px; }
    }
    </style>
</head>
<body>
<div class="card">
    <div id="title" class="title">MONIKERS</div>
    <div id="description" class="description"></div>
    <div class="line"></div>
    <div id="points-box" class="points-box">
        <div id="points" class="points">0</div>
        <div class="points-label">Punti</div>
    </div>
</div>
<div style="display: block; margin:auto; text-align: center;">
    <div id="skipButton" class="doubleButton" onclick="change();">
        <div id="skip">PASSA</div>
    </div>
    <div id="correctButton" class="doubleButton" onclick="correct();">
        <div id="correct">CORRETTO</div>
    </div>
</div>
<div class="button" onclick="start();">
    <div id="start">INIZIA</div>
    <progress value="0" max="30" id="progressBar" style="display: none;"></progress>
</div>
<script>
    function shuffle(array) {
      var currentIndex = array.length, temporaryValue, randomIndex;
      while (0 !== currentIndex) {
        randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex -= 1;
        temporaryValue = array[currentIndex];
        array[currentIndex] = array[randomIndex];
        array[randomIndex] = temporaryValue;
      }
      return array;
    }

    var roundInfo = [
        "<br>ROUND 1:<br>Puoi usare ogni parola, suono o gesto tranne il nome stesso, puoi usare anche il testo sulla carta. Se dici una parte qualsiasi del nome, devi saltare quella carta.",
        "<br>ROUND 2:<br>Usa una sola parola, che pu√≤ essere qualsiasi cosa tranne il nome stesso. Puoi ripetere quella parola quante volte vuoi, ma non puoi fare gesti o suoni.",
        "<br>ROUND 3:<br>Solo mimando. Nessuna parola e gli effetti sonori non sono consentiti."];
    var round = 1;
    var cards = [];
    var remainingCards = [];
    var currentCardIndex = -1;
    var points = [0,0];
    var currentPlayer = 0;
    var playing = false;
    var playerPoints = 0;

    $.ajax({
        url: "monikers.csv",
        async: false,
        success: function (csvd) {
            cards = $.csv.toArrays(csvd);
        },
        dataType: "text",
        complete: function () {
            // Mischia le carte e sceglie la prima
            // TODO: prendere le carte in base al numero di giocatori con "cards.slice(0,numgiocatori*5)"
            var query = location.search.replace('?', '');
            var players = 4;
            if(query != ""){
                var params = parse_query_string(query);
                players = parseInt(params["players"]);
            }
            cards = shuffle(cards);
            if(players*5 < cards.length){
                cards = cards.slice(0,players*5);
            }
            remainingCards = cards.slice();
            setRoundInfo();
        }
    });

    function setRoundInfo(){
        $('#title').text("MONIKERS");
        $('#description').html(roundInfo[round-1]);
        $('#points').text("0");
    }

    function changePlayer(){
        if(currentPlayer == 0){
            currentPlayer = 1;
        } else {
            currentPlayer = 0;
        }
    }

    function change(){
        currentCardIndex++;
        if(remainingCards.length == 0){
            $('#title').text("FINE ROUND");
            $('#description').html("<div style=\"text-align:center\"><b>PUNTEGGIO SQUADRE:</b><br>Squadra 1: " + points[0] + "<br>Squadra 2: " + points[1] + "</div>");
            $('#points').text("0");
            $('#skipButton').hide();
            $('#correctButton').hide();
        } else if(currentCardIndex >= remainingCards.length){
          $('#title').text("FINE TURNO");
            $('#description').html("<div style=\"text-align:center\"><br>Hai totalizzato " + (playerPoints) + " punti!" + "</div>");
            $('#points').text("0");
            $('#skipButton').hide();
            $('#correctButton').hide();
        } else {
            var currentCard = remainingCards[currentCardIndex];
            $('#title').text(currentCard[0]);
            $('#description').text(currentCard[1]);
            $('#points').text(currentCard[2]);
            $('#points-box').css("background-color", getColor(parseInt(currentCard[2])));
        }
    }

    function getColor(points){
        switch (points) {
          case 1:
            return "#54b899";
            break;
          case 2:
            return "#15ace5";
            break;
          case 3:
            return "#8f66a5";
            break;
          case 4:
            return "#e84735";
            break;
          default:
            return "#15ace5";
        }
    }

    function correct(){
        var currentCard = remainingCards[currentCardIndex];
        var currentPoints = points[currentPlayer];
        points[currentPlayer] = currentPoints + parseInt(currentCard[2]);
        playerPoints = playerPoints + parseInt(currentCard[2]);
        remainingCards.splice(currentCardIndex, 1);
        currentCardIndex--;
        change();
    }

    function start(){
        if(!playing){
            playing = true;
            currentCardIndex = -1;
            playerPoints = 0;
            // Mischia le carte rimaste e sceglie la prima
            remainingCards = shuffle(remainingCards);
            startTimer();
        }
    }

    function startTimer(){
        change();
        $('#start').hide();
        $('#progressBar').show();
        $('#skipButton').css('display', 'inline-block');
        $('#correctButton').css('display', 'inline-block');
        var timeleft = 30;
        var downloadTimer = setInterval(function(){
          document.getElementById("progressBar").value = 30 - --timeleft;
          if(timeleft <= 0){
            changePlayer();
            $('#start').show();
            $('#progressBar').hide();
            $('#skipButton').hide();
            $('#correctButton').hide();
            clearInterval(downloadTimer);
            playing = false;
            if(remainingCards.length == 0 && round < 3){
                round++;
                remainingCards = cards.slice();
            }
            setRoundInfo();
            var audio = new Audio('buzz.mp3');
            audio.play();
          }
        },1000);
    }

    function parse_query_string(query) {
      var vars = query.split("&");
      var query_string = {};
      for (var i = 0; i < vars.length; i++) {
        var pair = vars[i].split("=");
        var key = decodeURIComponent(pair[0]);
        var value = decodeURIComponent(pair[1]);
        // If first entry with this name
        if (typeof query_string[key] === "undefined") {
          query_string[key] = decodeURIComponent(value);
          // If second entry with this name
        } else if (typeof query_string[key] === "string") {
          var arr = [query_string[key], decodeURIComponent(value)];
          query_string[key] = arr;
          // If third or later entry with this name
        } else {
          query_string[key].push(decodeURIComponent(value));
        }
      }
      return query_string;
    }
</script>
</body>
</html>
